<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Walls</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif; padding:2rem;}
      header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
      .muted{opacity:.7;font-size:.9rem;}
      table{border-collapse:collapse; width:100%;}
      th,td{border:1px solid #ddd; padding:.5rem; text-align:left;}
      th{background:#fafafa;}
      .available{color:#0a7; font-weight:600;}
      .reserved{color:#b00; font-weight:600;}
      .expired{color:#b00; font-weight:600;}
      .mine{background: #fff7e6;}
      .me-badge{display:inline-block; margin-left:.4rem; padding:.1rem .35rem; border-radius:6px; font-size:.75rem; background:#0a7; color:#fff;}
      form.inline{display:inline;}
      select{font:inherit; padding:.2rem .3rem;}
      button{font:inherit; padding:.3rem .6rem; border:1px solid #ccc; border-radius:6px; background:#fff; cursor:pointer;}
    </style>
</head>
<body>
  <header>
    <div><strong>Test Walls</strong></div>
    <div class="muted">
      Signed in as <strong>{{ user }}</strong> &nbsp;â€¢&nbsp; <a href="/logout">Log out</a>
    </div>
  </header>

  <p class="muted">Server time: {{ time }}</p>

  <table id="resources-table">
    <thead>
      <tr>
        <th>Resource</th>
        <th>Status</th>
        <th>Reserved by</th>
        <th>Expires at</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tbody">
      {% for r in resources %}
      <tr data-id="{{ r.id }}" class="{% if r.reserved_by == user %}mine{% endif %}">
        <td class="name">{{ r.name }}</td>
        <td class="status">
          {% if r.reserved_by %}
            <span class="reserved">Reserved</span>{% if r.reserved_by == user %}<span class="me-badge">me</span>{% endif %}
          {% else %}
            <span class="available">Available</span>
          {% endif %}
        </td>
        <td class="by">{{ r.reserved_by or '-' }}</td>
        <td class="expires" data-expires="{{ r.expires_at or '' }}">{{ r.expires_at or '-' }}</td>
        <td class="action">
          {% if not r.reserved_by %}
            <form class="inline reserve-form" method="post" action="/reserve" onsubmit="return buildTimeAndSubmit(this)">
              <input type="hidden" name="resource_id" value="{{ r.id }}">
              <label class="muted" for="h-{{ r.id }}">Time:</label>
              <select id="h-{{ r.id }}" class="hh">
                {% for H in range(0,24) %}<option value="{{ '%02d' % H }}">{{ '%02d' % H }}</option>{% endfor %}
              </select> :
              <select class="mm">
                <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
              </select>
              <input type="hidden" name="expires_hhmm" value="">
              <button type="submit">Reserve</button>
            </form>
          {% elif r.reserved_by == user %}
            <form class="inline release-form" method="post" action="/release">
              <input type="hidden" name="resource_id" value="{{ r.id }}">
              <button type="submit">Release</button>
            </form>
          {% else %}
            <span class="muted">Owned by {{ r.reserved_by }}</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    function pad(n){ return String(n).padStart(2,'0'); }
    function fmtNice(dt){
      if(!dt) return '-';
      const now = new Date();
      const sameDay = dt.getFullYear()===now.getFullYear() && dt.getMonth()===now.getMonth() && dt.getDate()===now.getDate();
      const h = pad(dt.getHours()), m = pad(dt.getMinutes());
      if(sameDay) return h+':'+m;
      return dt.getFullYear()+'-'+pad(dt.getMonth()+1)+'-'+pad(dt.getDate())+' '+h+':'+m;
    }
    function fmtCountdown(ms){
      if(ms <= 0) return 'Expired';
      const s = Math.floor(ms/1000);
      const d = Math.floor(s/86400);
      const h = Math.floor((s%86400)/3600);
      const m = Math.floor((s%3600)/60);
      const parts = [];
      if(d) parts.push(d+'d');
      if(h) parts.push(h+'h');
      parts.push(m+'m');
      return 'in '+parts.join(' ');
    }
    function parseISO(s){ return s ? new Date(s) : null; }

    function nextQuarter(){
      const now = new Date();
      const total = now.getHours()*60 + now.getMinutes();
      const next = Math.ceil(total/15)*15;
      return { h: pad(Math.floor((next/60)%24)), m: pad(next%60) };
    }

    function initReserveForm(form){
      const hh = form.querySelector('.hh');
      const mm = form.querySelector('.mm');
      if(hh && mm){
        const nq = nextQuarter();
        if(!hh.value) hh.value = nq.h;
        if(!mm.value) mm.value = nq.m;
      }
    }

    function buildTimeAndSubmit(form){
      const hh = form.querySelector('.hh').value;
      const mm = form.querySelector('.mm').value;
      form.querySelector('input[name=\"expires_hhmm\"]').value = hh+':'+mm;
      return true;
    }

    function tickCountdown(){
      document.querySelectorAll('td.expires').forEach(function(td){
        var iso = td.dataset.expires;
        if(!iso){ td.textContent='-'; return; }
        var dt = parseISO(iso);
        if(!dt || isNaN(dt)) { td.textContent='-'; return; }
        var now = new Date();
        var ms = dt - now;
        var nice = fmtNice(dt);
        if(ms <= 0){
          td.innerHTML = '<span class="expired">Expired</span>';
        } else {
          td.textContent = nice+' ('+fmtCountdown(ms)+')';
        }
      });
    }
    setInterval(tickCountdown, 1000);
    tickCountdown();

    async function poll(){
      try{
        var res = await fetch('/resources');
        var data = await res.json();
        if(!data || !Array.isArray(data.resources)) return;
        render(data.resources);
      }catch(e){}
    }
    setInterval(poll, 5000);

    function render(resources){
      var tbody = document.getElementById('tbody');
      var map = {};
      resources.forEach(function(r){ map[r.id]=r; });
      Array.from(tbody.querySelectorAll('tr[data-id]')).forEach(function(tr){
        var id = tr.dataset.id;
        var r = map[id];
        if(!r) return;
        var statusCell = tr.querySelector('.status');
        var byCell = tr.querySelector('.by');
        var expCell = tr.querySelector('.expires');
        var actionCell = tr.querySelector('.action');

        var active = document.activeElement;
        var isEditing = active && actionCell.contains(active);
        var hhSel = actionCell.querySelector('select.hh');
        var mmSel = actionCell.querySelector('select.mm');
        var hasTyped = (hhSel && mmSel && (hhSel.value || mmSel.value));

        var desiredMode = !r.user ? 'reserve' : (r.user === '{{ user }}' ? 'release' : 'owned');
        var currentMode = actionCell.querySelector('form.reserve-form') ? 'reserve' : (
          actionCell.querySelector('form.release-form') ? 'release' : (
            actionCell.querySelector('.muted') ? 'owned' : 'unknown'
          )
        );

        // status + me badge + row highlight
        if(r.user){
          statusCell.innerHTML = '<span class="reserved">Reserved</span>' + (r.user === '{{ user }}' ? '<span class="me-badge">me</span>' : '');
          tr.classList.toggle('mine', r.user === '{{ user }}');
        } else {
          statusCell.innerHTML = '<span class="available">Available</span>';
          tr.classList.remove('mine');
        }

        byCell.textContent = r.user || '-';
        expCell.dataset.expires = r.expires_at || '';

        var shouldReplace = (desiredMode !== currentMode) || (!isEditing && !hasTyped);
        if(shouldReplace){
          if(desiredMode === 'reserve'){
            actionCell.innerHTML = `
              <form class="inline reserve-form" method="post" action="/reserve" onsubmit="return buildTimeAndSubmit(this)">
                <input type="hidden" name="resource_id" value="${id}">
                <label class="muted" for="h-${id}">Time:</label>
                <select id="h-${id}" class="hh">
                  ${Array.from({length:24}, (_,H)=>('<option value=\"'+pad(H)+'\">'+pad(H)+'</option>')).join('')}
                </select> :
                <select class="mm">
                  <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                </select>
                <input type="hidden" name="expires_hhmm" value="">
                <button type="submit">Reserve</button>
              </form>`;
            var form = actionCell.querySelector('form.reserve-form');
            initReserveForm(form);
          } else if(desiredMode === 'release'){
            actionCell.innerHTML = `
              <form class="inline release-form" method="post" action="/release">
                <input type="hidden" name="resource_id" value="${id}">
                <button type="submit">Release</button>
              </form>`;
          } else {
            actionCell.innerHTML = '<span class="muted">Owned by '+(r.user||'')+'</span>';
          }
        }
      });
      tickCountdown();
    }

    // Initialize server-rendered reserve forms to next quarter
    document.querySelectorAll('form.reserve-form').forEach(initReserveForm);
  </script>
</body>
</html>
